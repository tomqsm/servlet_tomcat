<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE urlrewrite PUBLIC "-//tuckey.org//DTD UrlRewrite 4.0//EN"
        "http://www.tuckey.org/res/dtds/urlrewrite4.0.dtd">
<urlrewrite use-context="false">

    <!--LOGIN-->
    <rule enabled="true" match-type="regex">
        <name>loginFailureToCleanUrlEN</name>
        <note>When url based language choice is maintained, this rule allows to set preference to user language choice from dropdown over user preferences from browser setting.</note>
        <condition type="session-attribute" name="language" operator="equal">^en$</condition>
        <from>^(.*)/failed$</from>
        <set name="failed">true</set>
        <set name="log.info">loginFailureToCleanUrlEN | Session: %{requested-session-id}</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
        <to type="forward" last="true">/%{session-attribute:language}/login.ftl</to>
    </rule>
    <rule enabled="true" match-type="regex">
        <name>loginFailureToCleanUrlPL</name>
        <condition type="session-attribute" name="language" operator="equal">^pl$</condition>
        <from>^(.*)/failed$</from>
        <set name="failed">true</set>
        <set name="log.info">loginFailureToCleanUrlPL | Session: %{requested-session-id}</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
        <to type="forward" last="true">/login.ftl</to>
    </rule>
    <rule enabled="true" match-type="regex">
        <name>loginform</name>
        <condition type="method">POST</condition>
        <from>^(.*)/loginform$</from>
        <set name="log.info">loginform | username: %{parameter:username} password: %{parameter:password}, language: %{parameter:language}</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
        <set type="parameter" name="j_username">%{parameter:username}</set>
        <set type="parameter" name="j_password">%{parameter:password}</set>
        <set type="session" name="language">%{parameter:language}</set>
        <to type="redirect" last="true" qsappend="true">j_security_check</to>
    </rule>
     
    <!--START LANGUAGE TO URL GROUP runs on / root call-->
    <rule enabled="true" match-type="regex">
        <name>setBrowserLanguage</name>
        <condition type="method">GET</condition>
        <from>^/$</from>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.ClientLanguageSetter" neweachtime="true"/>
        <set name="log.info">setBrowserLanguage: %{attribute:browserLanguage}</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
    </rule>
    <rule enabled="true" match-type="regex">
        <name>browserLanguageNotPL->Redirect</name>
        <condition type="method">GET</condition>
        <condition type="attribute" name="browserLanguage" operator="notequal">^/$</condition>
        <set name="log.info">browserLanguageNotPL->Redirect: %{context-path}/%{attribute:browserLanguage}/index</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
        <from>^/$</from>
        <to type="temporary-redirect" last="true">%{context-path}/%{attribute:browserLanguage}/index</to>
    </rule>
    <rule enabled="true" match-type="regex">
        <name>browserLanguagePL->Forward</name>
        <condition type="method">GET</condition>
        <condition type="attribute" name="browserLanguage" operator="equal">^/$</condition>
        <set name="log.info">browserLanguagePL->Forward: %{request-uri} %{attribute:browserLanguage}index</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log"/>
        <from>^/$</from>
        <to type="forward" last="true">%{attribute:browserLanguage}index</to>
    </rule>
    <!-- END LANGUAGE TO URL GROUP-->
    
    <outbound-rule enabled="true" match-type="regex">
        <name>setLanguageFromRefererAndRequestPath</name>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.URLLanguageSetter" method="setPathFromLang" />
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.URLLanguageSetter" method="setPathToLang" />
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.URLLanguageSetter" method="setServletPathWithoutLanguage" />
        <set name="log.info">setLanguageFromRefererAndRequestPath</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log" />
        <from>^(en|pl|de)(.*)$</from>
    </outbound-rule> 

    <outbound-rule enabled="true" match-type="regex">
        <name>outboundRewriteForEN</name>
        <from>^en(.*)$</from>
        <set name="log.info">outboundRewriteForEN</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log" />
        <to last="true">%{context-path}/en%{attribute:servletPathWithoutLanguage}</to>
    </outbound-rule>
    
        <outbound-rule enabled="true" match-type="regex">
        <name>outboundRewriteForDE</name>
        <from>^de(.*)$</from>
        <set name="log.info">outboundRewriteForDE: fromServlet: %{attribute:fromServlet}, pathFromLang: %{attribute:pathFromLang}, pathToLang: %{attribute:pathToLang}</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log" />
        <to last="true">%{context-path}/de%{attribute:servletPathWithoutLanguage}</to>
    </outbound-rule>

    <outbound-rule enabled="true" match-type="regex">
        <name>outboundRewriteForPL</name>
        <from>^pl(.*)$</from>
        <set name="log.info">outboundRewriteForPL</set>
        <run class="com.letsweb.tutorial.servlet_tomcat.rewriting.RewritingLogger" method="log" />
        <to last="true">%{context-path}%{attribute:servletPathWithoutLanguage}</to>
    </outbound-rule>
    
    <rule enabled="true" match-type="regex">
        <condition type="method">GET</condition>
        <from>^/en/podlogi$</from>
        <run class="com.letsweb.tutorial.servlet_tomcat.pages.LinksController" method="doGetPodlogi" />
        <to type="forward">template.ftl</to>
    </rule>
    <rule enabled="true" match-type="regex">
        <condition type="method">GET</condition>
        <from>^/podlogi$</from>
        <run class="com.letsweb.tutorial.servlet_tomcat.pages.LinksController" method="doGetPodlogi" />
        <to type="forward">template.ftl</to>
    </rule>

    
</urlrewrite>
